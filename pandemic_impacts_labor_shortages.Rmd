---
title: "Impacts on workforce shortages"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

<link rel="stylesheet" href="styles.css" type="text/css">

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(extrafont)
library(readxl)
library(janitor)
library(lubridate)

loadfonts()
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

```

```{r master ui objects, include=FALSE, cache=TRUE}

ui.occ.edr <- read_csv("Data/UI/Master-ui-claims-occ-edr.csv") %>%
  mutate(edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast")) 

```

```{r master job postings objects, include=FALSE, cache=TRUE}
master.job.postings.with.family <- read_csv("Data/Job postings/master-job-postings-job-family.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         date = as_date(date),
         posting.date = as_date(posting.date))

master.job.postings.with.family.occ <- read_csv("Data/Job postings/master-job-postings-job-family-and-occ.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         date = as_date(date),
         posting.date = as_date(posting.date))

```

```{r master oes objects, include=FALSE, cache=TRUE}

oes.edr <- read_csv("Data/Occupations/OES/Master-oes-edr.csv") %>%
   mutate(edr = str_replace(edr, "  ", " "),
          edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  left_join(regions, by = "edr") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))
```

<br>

Although our analysis has shown that there are a significant number of jobs available in Greater Minnesota, the next question is whether employers have access to a "ready-to-work" pool of unemployed individuals. Essentially, do "in-demand" occupations (occupations with many positions available) have access to an unemployment pool within the same occupation or is their a mismatch? The following sections examine the unemployment claims by occupation and the job postings by occupations to determine which occupation group might find it challenging to tap the larger than normal unemployment pool that currently exists.

# How many occupation groups have more job postings than weekly UI claims (shortage of workers)?{.tabset}

Despite the significant disruption on the social and economic life of Minnesotan's and the resulting increases of individuals filing unemployment claims throughout 2020, there continues to be a number of occupations that continue to face workforce shortages. 

The chart below provides the number of occupation groups in each region that had more weekly job positions available than unemployment claims. Although each region has experienced an increase in their occupations in this situation, the most significant growth has occurred in Greater Minnesota.

In Northwest Minnesota, EDR 1 - Northwest, and EDR 4 - West Central have ten or more occupation groups (of 22) that currently have more job positions than individuals filing for continuous unemployment insurance claims by the end of October. In Southern Minnesota, all of the EDRs have more than 10 occupation groups in the same situation.  


<br>

## Number of occupations with workforce shortages


```{r prep labor shortage occ number edr, include=FALSE, cache=TRUE}
ui.weekly.occ.edr <- ui.occ.edr %>%
  gather(key = "ui.date", value = "ui.claims", 3:(max(ncol(ui.occ.edr))-1)) %>%
  mutate(`Dim Title` = str_replace(`Dim Title`, " Occupations", ""),
         `Dim Title` = str_replace(`Dim Title`, " Occup.", ""),
         `Dim Title` = str_replace(`Dim Title`, " Occ", ""),
         `Dim Title` = as.factor(`Dim Title`)) %>%
  mutate(ui.date = mdy(ui.date),
         ui.month = month(ui.date, label = TRUE)) %>%
  group_by(edr, planning.region, `Dim Title`, ui.month) %>%
  mutate(week = seq(n())) %>%
  ungroup() %>%
  drop_na(ui.claims)

job.postings.weekly.occ.edr <- master.job.postings.with.family %>%
  group_by(edr, planning.region, posting.date) %>%
  distinct(jvid, .keep_all = TRUE) %>%
  ungroup() %>%
  group_by(edr, planning.region, posting.date, Job_Family) %>%
  summarise(job.postings = n()) %>%
  ungroup() %>%
  mutate(posting.month = month(posting.date, label = TRUE)) %>%
  group_by(edr, planning.region, Job_Family, posting.month) %>%
  mutate(week = seq(n())) %>%
  ungroup() %>%
  mutate(Job_Family = str_replace(Job_Family, "Community and Social Service", "Community and Social Services"),
         Job_Family = str_replace(Job_Family, "Building and Grounds Cleaning and Maintenance", "Building & Grounds Cleaning & Maintenance"),
         Job_Family = as.factor(Job_Family))


ui.job.postings.weekly.occ.edr <- ui.weekly.occ.edr %>%
  full_join(job.postings.weekly.occ.edr[,c(1,2,3,4,5,6,7)], by = c("edr", "planning.region", "ui.month" = "posting.month", "week", `Dim Title` = "Job_Family")) %>%
  filter(ui.month %in% c("Sep", "Oct"),
         `Dim Title` != "Total Claims",
         edr != "Minnesota") %>%
  group_by(edr, planning.region, ui.month, week) %>%
  fill(ui.date, .direction = "downup") %>%
  ungroup() %>%
  mutate(ui.claims = ifelse(is.na(ui.claims), 0, ui.claims),
         job.postings = ifelse(is.na(job.postings), 0, job.postings),
         job.posting.ui.difference = job.postings - ui.claims)



labor.shortage.edr <- ui.job.postings.weekly.occ.edr %>%
  mutate(shortage.surplus = ifelse(job.posting.ui.difference > 0, "Shortage", NA)) %>%
  filter(shortage.surplus == "Shortage")


labor.shortages.occ.number.edr <- labor.shortage.edr %>%
  group_by(edr, planning.region, ui.date) %>%
  summarise(number.occ.shortages = n()) %>%
  ungroup() %>% 
  mutate(data_id = seq(n()))

labor.surplus.edr <- ui.job.postings.weekly.occ.edr %>%
  mutate(shortage.surplus = ifelse(job.posting.ui.difference < 0, "Surplus", NA)) %>%
  filter(shortage.surplus == "Surplus")


labor.surpluses.occ.number.edr <- labor.surplus.edr %>%
  group_by(edr, planning.region, ui.date) %>%
  summarise(number.occ.surpluses = n()) %>%
  ungroup() %>% 
  mutate(data_id = seq(n()))



```

```{r chart labor shortages occ number edr}
labor.shortages.occ.number.edr.plot <- ggplot(labor.shortages.occ.number.edr, aes(ui.date, number.occ.shortages, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\n", ui.date, "\nNumber of occupation groups with workforce shortages: ", comma(number.occ.shortages, accuracy = 1), sep = ""))) +
  labs(x="", y = "", color="", title = "Number of occupation groups with more jobs available than unemployment claims") +
  geom_label(data = filter(labor.shortages.occ.number.edr, ui.date == max(labor.shortages.occ.number.edr$ui.date)), aes(x = ui.date, y = number.occ.shortages, label = comma(number.occ.shortages, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = labor.shortages.occ.number.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

## Number of occupations with workforce surpluses

```{r chart labor surpluses occ number edr}
labor.surpluses.occ.number.edr.plot <- ggplot(labor.surpluses.occ.number.edr, aes(ui.date, number.occ.surpluses, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\n", ui.date, "\nNumber of occupation groups with workforce surpluses: ", comma(number.occ.surpluses, accuracy = 1), sep = ""))) +
  labs(x="", y = "", color="", title = "Number of occupation groups with less jobs available than unemployment claims") +
  geom_label(data = filter(labor.surpluses.occ.number.edr, ui.date == max(labor.surpluses.occ.number.edr$ui.date)), aes(x = ui.date, y = number.occ.surpluses, label = comma(number.occ.surpluses, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = labor.surpluses.occ.number.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

# Which occupation groups are experiencing a shortage in their workforce?{.tabset}

Analysis of the data shows that there were 16 different occupation groups experiencing a workforce shortage in at least one of our EDRs. The table below provides  a list of each of those occupations and the number of EDRs where they are experiencing a workforce shortage. A workforce shortage here is defined as an occupation having more job postings on average than the average weekly unemployment claims for the month of October.

What is apparent is that there is significant breadth to the occupation groups that have workforce shortages. Even for occupation groups such as computer and mathematical which one might view as being largely available in the seven county metro is actually facing shortages in 7 of our 13 EDRs. 


<br>

```{r table number of edrs occupation groups are in with shortages}
ui.job.postings.octavg.edr <- ui.job.postings.weekly.occ.edr %>%
  filter(ui.month == "Oct",
         `Dim Title` != "unknown") %>%
  group_by(edr, `Dim Title`) %>%
  summarise(avg.job.posting.ui.difference = round(mean(job.posting.ui.difference))) %>%
  ungroup() %>%
  mutate(shortage.surplus = ifelse(avg.job.posting.ui.difference > 0, "Shortage", "Surplus"))

labor.shortage.octavg.occ.num.edr <- ui.job.postings.octavg.edr %>%
  filter(shortage.surplus == "Shortage") %>%
  group_by(`Dim Title`) %>%
  distinct(edr) %>%
  summarise(num.edrs = n()) %>%
  ungroup() %>%
  mutate(pct.edrs = num.edrs / 13) %>%
  arrange(desc(num.edrs)) %>%
  rename(`Occ Group` = 1,
         `Number of EDRs with workforce shortage` = 2,
         `% of EDRs with workforce shortage` = 3)

labor.surplus.octavg.occ.num.edr <- ui.job.postings.octavg.edr %>%
  filter(shortage.surplus == "Surplus") %>%
  group_by(`Dim Title`) %>%
  distinct(edr) %>%
  summarise(num.edrs = n()) %>%
  ungroup() %>%
  mutate(pct.edrs = num.edrs / 13) %>%
  arrange(desc(num.edrs)) %>%
  rename(`Occ Group` = 1,
         `Number of EDRs with workforce surplus` = 2,
         `% of EDRs with workforce surplus` = 3)

write_csv(labor.surplus.octavg.occ.num.edr, "Data/Forecasts/current-occ-group-surplus-num-edrs.csv")
write_csv(labor.shortage.octavg.occ.num.edr, "Data/Forecasts/current-occ-group-shortage-num-edrs.csv")

kable(format = "html", labor.shortage.octavg.occ.num.edr, escape = F, align = "c", caption = "Number of EDRs where an occupation group was facing a workforce shortage using the average difference between job postings and unemployment claims through the month of October.") %>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  scroll_box(width = "100%", height = "100%")


```

<br>

The first tab below - "Occupation groups with workforce shortages in each EDR" - provides the occupation groups that are facing workforce shortages in each of the EDRs using the weekly difference between job postings and unemployment claims averaged for the month of October. It also provides how many more job positions were posted on average weekly basis compared to the number of unemployment claims for October. 

The first thing that jumps out from this list is the amount of people needed to work in the healthcare practitioners and technical field. It's at the top of the workforce shortage list for nearly every EDR. Skimming the table also shows that there are quite a few occupation groups listed that never appeared on the unemployment claims lists and were not ranked very high for the jobs "in-demand" list. Occupation groups such as architecture and engineering, computer and mathematical, life, physical and social science, and others appear here. What's interesting about the list is how some occupations that haven't been at the top of any of the previous lists are at the top here. One occupation group you don't see on this list is food preparation and serving related.

In the second tab is a table providing the top-5 specific occupations (6-digit SOC) for the top-5 occupation groups with the largest workforce shortage by the end of October. It's worth noting the breadth of occupation groups and occupations even within the top-5 in at least one EDR. Overall, there were 16 different occupation groups that were in the top-5 largest workforce shortages in at least on EDR. Here's a quick summary of the types of jobs available for a majority of the occupation groups.

* Healthcare practitioners and technical (in top-5 for 13/13 EDRs): Nearly all of the positions available were concentrated in two occupations - registered nurses and licensed practical and licensed vocational nurses. However, due to the large need for workers in this occupation group, there is significant need for workers in many occupations within this field.

* Community and social services (in top-5 for 12 of 13 EDRs): Nearly all of the positions available were categorized as social and human service assistant or mental health and substance abuse counselors.

* Architecture and engineering (in top-5 for 9 of 13 EDRs) : A majority of these positions were classified as industrial or mechanical engineers. 

* Life, physical, and social science (in top-5 for 9 of 13 EDRs): the occupations available within this field was dependent on location. In our northern regions, the occupations were primarily revolve around environmental sciences and protection otherwise the majority of jobs were in the medical scientists occupations.

* Transportation and material moving (in top-5 for 6 of 13 EDRs): Most of the positions were concentrated in heavy and tracter-trailer truck driver, light truck or delivery services, drivers or sales workers, as well as laborers and freight, stock, and material movers. 

* Computer and mathematical (in top-5 for 5 of 13 EDRs): A majority of these occupations were classified as "computer occupations" or "software developers".

* Personal care and service (in top-5 for 4 of 13 EDRs): most of the positions were concentrated in the personal care aides occupations.

* Building & Grounds Cleaning & Maintenance (in top-5 for 1 of 13 EDRs): 

* Business and financial operations (in top-5 for 1 of 13 EDRs): the majority of occupations in this field were classified as "management analysts" or "business operations specialists". 

* Installation, maintenance, and repair (in top-5 for 1 of 13 EDRs): A majority of the jobs in this occupation group were classified as "maintenance and repair workers" or "first-line supervisors of mechanics, installers and repairers".

* Protective Service (in top-5 for 1 of 13 EDRs): a majority of the jobs in this field were security guards. 

<br>

```{r prep top occupations with labor shortages, include=FALSE, cache=TRUE}
labor.shortages.occ.octavg <- ui.job.postings.octavg.edr %>%
  filter(shortage.surplus == "Shortage") %>%
  mutate(worker.label = avg.job.posting.ui.difference * -1) %>%
  group_by(edr) %>%
  arrange(worker.label) %>%
  mutate(rank = seq(n())) %>%
  ungroup()

top5 <- labor.shortages.occ.octavg %>%
  filter(rank < 6) %>%
  group_by(`Dim Title`) %>%
  distinct(edr) %>%
  summarise(num.edrs = n()) %>%
  ungroup()


labor.shortages.octavg.occ.table.edr <- labor.shortages.occ.octavg %>%
  mutate(label = paste(`Dim Title`, ": ", worker.label, sep = ""),
         label = ifelse(is.na(label), "", label)) %>%
  select(1,6,7) %>%
  spread(key = edr, value = label)

```

## Occupation groups with workforce shortages in each EDR

```{r table top occupations with labor shortages}
datatable(labor.shortages.octavg.occ.table.edr, class = "cell-border stripe", filter = "top", rownames = FALSE, caption = "The table provides the occupation group ranked by workforce shortage severity. The workforce shortage is the average number of wokers the occupation was facing each week a job was posted in the month of October.",
          options = list(scrollX = TRUE)) 
```

## Top-5 specific occupations (6-digit SOC) available within the top-5 occupation groups with workforce shortages

<br>

```{r prep top SOC positions available, include=FALSE, cache=TRUE}
job.postings.soc.unique.by.month.edr <- master.job.postings.with.family.occ %>%
  mutate(posting.month = month(posting.date, label = TRUE)) %>%
  group_by(posting.month) %>%
  distinct(jvid, .keep_all = TRUE) %>%
  ungroup() %>%
  uncount(positions) %>%
  mutate(soc.1 = str_sub(soc, 3, 8),
         soc.2 = str_sub(soc, 13, 18),
         soc.3 = str_sub(soc, 23, 28),
         length = str_length(soc),
         soc.1 = ifelse(length == 4, "", soc.1))  

soc.codes <- read_xlsx("Data/Job postings/soc-codes.xlsx") %>%
  mutate(major = ifelse(is.na(major), minor, major),
         major = ifelse(is.na(major), broad, major),
         major = ifelse(is.na(major), detailed, major),
         major = str_replace(major, "-", ""),
         major = as.factor(major)) %>%
  select(1,5) %>%
  rename(soc.code = 1)

labor.shortages.top5.occ.list.edr <- labor.shortages.occ.octavg %>%
  group_by(edr) %>%
  filter(rank <= 5) %>%
  ungroup() %>%
  select(1,6,2) %>%
  rename(Job_Family = 3)


job.postings.soc.octavg.edr <- job.postings.soc.unique.by.month.edr %>%
  select(23, 12,25, 26,27,28) %>%
  filter(posting.month == "Oct") %>%
  group_by(edr, posting.month, Job_Family) %>%
  mutate(job.family.positions = n()) %>%
  ungroup %>%
  group_by(edr, posting.month) %>%
  mutate(total.positions = n()) %>%
  ungroup() %>%
  gather(key = "soc.level", value = "soc", 4:6) %>%
  mutate(soc = as.factor(soc)) %>%
  group_by(edr, soc, posting.month) %>%
  mutate(soc.positions = n()) %>%
  distinct(soc, .keep_all = TRUE) %>%
  ungroup() %>%
  left_join(soc.codes, by = c("soc" = "soc.code")) %>%
  mutate(title = ifelse(is.na(title), "Unknown", title)) %>%
  group_by(edr, soc, title) %>%
  mutate(avg.soc.position = round(mean(soc.positions))) %>%
  ungroup() %>%
  group_by(edr, Job_Family) %>%
  mutate(avg.job.family.positions = round(mean(job.family.positions))) %>%
  ungroup() %>%
  select(1,2,7,9,10,11,5) %>%
  mutate(job.family.pct.total = avg.job.family.positions / total.positions,
         soc.positions.pct.job.family = avg.soc.position / avg.job.family.positions)

labor.shortage.soc.top5.edr <- job.postings.soc.octavg.edr %>%
  group_by(edr, Job_Family) %>%
  top_n(n = 5, wt = avg.soc.position) %>%
  arrange(desc(avg.soc.position)) %>%
  ungroup() %>%
  right_join(labor.shortages.top5.occ.list.edr, by = c("edr", "Job_Family")) %>%
  select(1,10,2,4,5,9) %>%
  rename("EDR" = 1,
         "Rank by largest workforce shortage in job family" = 2,
         "Job Family" = 3,
         "Occupation Title" = 4,
         "Avg number of positions available" = 5,
         "Positions of job as a percent of all openings in job family" = 6)


```


<br>

```{r detailed occupations of top 5 occupation groups facing workforce shortages}
datatable(labor.shortage.soc.top5.edr[order(labor.shortage.soc.top5.edr$EDR, labor.shortage.soc.top5.edr$`Rank by largest workforce shortage in job family`), ],
          class = "cell-border stripe",
          filter = "top",
          rownames = FALSE,
          extensions = "RowGroup",
          options = list(scrollX = TRUE,
                         rowGroup = list(dataSrc = c(0,2)))) %>%
  formatPercentage(6)
```


<br>

# Comparing occupations with workforce shortages vs surpluses

The table below provides each occupation group that had a workforce shortage or a workforce surplus throughout the month of October. Overall, comparing the occupations reveals a couple themes in rural Minnesota. 

First, the major disruptions the pandemic has had to certain industries has caused high unemployment and workforce surpluses in occupations that require a lower skill-set in every region. These occupation groups were also some of the most severe in terms of experiencing workforce surpluses. 

+ Food preparation and serving related
+ Sales and related
+ Office and administrative support

The skills needed for this type of employment don't typically align well with the skills required for many of the jobs in occupation groups that were experiencing a workforce shortage in nearly every region.

+ Healthcare practitioners and technical
+ community and social services
+ Architecture and engineering
+ Computer and mathematical
+ Life, physical, and social science

Other occupation groups that were experiencing more unemployment claims than job positions available but requires training and education;

+ Education, training, and library.
+ Healthcare support

In addition, October is a transition month where many industries begin laying off workers for the winter. There were quite a few occupation groups that were experiencing a higher number of unemployment claims than job postings but is typical for this time of year across nearly all regions.

+ Production
+ Construction and extraction
+ Farming, fishing and forestry
+ Building and grounds cleaning and maintenance

There are a few other occupation groups that show up in the rural EDRs that are a bit more complicated. These occupation groups can either show up as experiencing workforce surpluses or shortages depending on the region. It's challenging to determine what's causing this but it's likely due to the differences in industry make-up of each region and they specific types of product or service being produced. For example, transportation and material moving in Northwest and Southwest might be experiencing more unemployment claims in October due to their being less agricultural product to move while in Central these type of jobs are more linked to commerce and are gearing up for he holiday season.

+ Transportation and material moving
+ Management
+ Business and financial operations
+ Installation, maintenance and repair
+ Arts, design, entertainment, sports, and media
+ Personal care and service

What this tells us is that even though there are some main occupations being impacted by the pandemic, the workforce and industry dynamics are still quite complicated and nuanced. Even in a significant global even such as we are in right now, each workforce development organization is facing their own unique situation requiring individual strategies and programming. 

<br>

```{r prep occupations with laborforce shortages vs surpluses, include=FALSE, cache=TRUE}
labor.surplus.octavg.edr <- ui.job.postings.octavg.edr %>%
  filter(shortage.surplus == "Surplus",
         avg.job.posting.ui.difference < 0) 

labor.surplus.table <- labor.surplus.octavg.edr %>%
  group_by(edr) %>%
  arrange(avg.job.posting.ui.difference) %>%
  mutate(rank = seq(n())) %>%
  ungroup() %>%
  mutate(avg.job.posting.ui.difference = avg.job.posting.ui.difference * -1,
         label = paste(`Dim Title`, ": ", avg.job.posting.ui.difference, sep = "")) %>%
  select(1,5,6)

labor.shortage.table <- labor.shortages.occ.octavg %>%
  mutate(label = paste(`Dim Title`, ": ", avg.job.posting.ui.difference, sep = "")) %>%
  select(1,6,7)

  labor.shortage.surplus.table <- labor.surplus.table %>%
  left_join(labor.shortage.table, by = c("edr", "rank")) %>%
  arrange(edr, rank) %>%
  rename(EDR = 1,
         "Rank by severity of shortage or surplus" = 2,
         "Occupation group and workforce surplus" = 3,
         "Occupation group and workforce shortage" = 4)
```

```{r table workforce shortage vs surplus}
datatable(labor.shortage.surplus.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) 
```

