---
title: "Pandemic impacts to future projections"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

<link rel="stylesheet" href="styles.css" type="text/css">

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(extrafont)
library(readxl)
library(janitor)
library(lubridate)

loadfonts()
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_edrs <- st_read("Data/Shapefiles/RDO shapefiles/rdo.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)

```

```{r master job forecast, include=FALSE, cache=TRUE}
emp.forecast.edr <- read_xlsx("Data/Forecasts/employment-forecast-edr.xlsx") %>%
  gather(key = "year", value = "emp", 2:28) %>%
  mutate(quarter = str_sub(year, 5,6 ),
         emp.type = str_sub(year, -5, -1),
         emp.type = str_replace(emp.type, "imate", "base"),
         emp.type = ifelse(emp.type %in% c("base", "covid"), emp.type, "emp"),
         emp = round(emp),
         year = str_sub(year, 1,6),
         EDR = str_replace(EDR, "MN ", ""),
         EDR = str_replace(EDR, "  ", " "),
         EDR = str_replace(EDR, "EDR 1 - NW", "EDR 1 - Northwest"),
         EDR = str_replace(EDR, "EDR 6E - SW Central", "EDR 6E- Southwest Central"),
         EDR = str_replace(EDR, "EDR 6W - Upper MN Valley", "EDR 6W- Upper Minnesota Valley"),
         EDR = str_replace(EDR, "EDR 7E - East Central", "EDR 7E- East Central"),
         EDR = str_replace(EDR, "EDR 7W - Central", "EDR 7W- Central"),
         EDR = str_replace(EDR, "EDR 8 - SW", "EDR 8 - Southwest"),
         EDR = str_replace(EDR, "EDR 10 - SE", "EDR 10 - Southeast"),
         EDR = str_replace(EDR, "EDR 11 - Metro", "EDR 11 - 7 County Twin Cities"),
         EDR = fct_relevel(EDR, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>% 
  filter(EDR != "Minnesota")

emp.forecast.added.edr <- emp.forecast.edr %>%
  mutate(year = as.factor(year)) %>%
  filter(year %in% c("2020Q1", "2021Q2")) %>%
  droplevels() %>%
  group_by(EDR) %>%
  complete(year, emp.type, fill = list(emp = NA)) %>%
  ungroup() %>%
  filter(year != "2021Q2") %>%
  group_by(EDR) %>%
  mutate(emp = ifelse(is.na(emp), emp[emp.type == "emp"], emp)) %>%
  ungroup() %>%
  filter(emp.type != "emp")

master.emp.forecast.edr <- emp.forecast.edr %>%
  rbind(emp.forecast.added.edr) %>%
  mutate(year = lubridate::yq(year),
         emp.type = as.factor(emp.type),
         emp.type = ifelse(emp.type == "emp", "Historical",
                           ifelse(emp.type == "covid", "Event-based model", "Baseline model")),
         emp.type = as.factor(emp.type),
         emp.type = relevel(emp.type, "Historical", "Baseline model", "Event-based model"),
         quarter = ifelse(is.na(quarter), "Q1", quarter))

forecast.final.project <- master.emp.forecast.edr %>%
  filter(year == max(master.emp.forecast.edr$year),
         quarter == "Q2") %>%
  group_by(EDR) %>%
  mutate(baseline.event.diff = emp[emp.type == "Event-based model"] - emp[emp.type == "Baseline model"],
         baselind.event.diff.pct = baseline.event.diff / emp[emp.type == "Baseline model"]) %>%
  ungroup()
```

```{r master forecast occ gaps, include=FALSE, cache=TRUE}
master.emp.forecast.occ.edr <- read_csv("Data/Forecasts/Master-occ-gaps-5yr-edr.csv") %>%
  mutate(edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

```

```{r master occ list, include=FALSE, cache=TRUE}
soc.codes <- read_xlsx("Data/Job postings/soc-codes.xlsx") %>%
  mutate(major = ifelse(is.na(major), minor, major),
         major = ifelse(is.na(major), broad, major),
         major = ifelse(is.na(major), detailed, major),
         major = str_replace(major, "-", ""),
         major = as.factor(major)) %>%
  select(1,5) %>%
  rename(soc.code = 1) %>%
  mutate(title = str_replace(title, " Occupations", ""))

```

```{r master ui objects, include=FALSE, cache=TRUE}

ui.occ.edr <- read_csv("Data/UI/Master-ui-claims-occ-edr.csv") %>%
  mutate(edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast")) 

```

```{r master job postings objects, include=FALSE, cache=TRUE}
master.job.postings.with.family <- read_csv("Data/Job postings/master-job-postings-job-family.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         date = as_date(date),
         posting.date = as_date(posting.date))

master.job.postings.with.family.occ <- read_csv("Data/Job postings/master-job-postings-job-family-and-occ.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         date = as_date(date),
         posting.date = as_date(posting.date))

```

```{r master oes data, include=FALSE, cache=TRUE}
oes.edr <- read_csv("Data/Occupations/OES/Master-oes-edr.csv") %>%
  mutate(edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

```

<br>

# How has the pandemic impacted employment forecasts?{.tabset}

Below are the number of jobs projected over the next 5 years in each EDR. There are three different datasets here, essentially. The first are the historical job numbers for each EDR before January 2020. After that, there are two projection models. The first model labeled "Baseline" were the job projections before the pandemic began. The second model labeled "Event-based" are the new projections since the pandemic has begun. This projection was modeled in quarter 3 of 2020. 

As the charts show, the pandemic caused a severe disruption in the number of jobs compared to what was projected for 2020. The event-based model currently projects a relatively quick recovery (v-shape) but a continued gap between what is projected now that the pandemic has occurred compared to the models before the pandemic began. This is due to the likely closure and slow recovery of the business directly impacted by the pandemic such as restaurants, bars, retail and other related industries.

<br>

## Trends

<br>

```{r chart emp forecast}
emp.forecast.edr.plot <- ggplot(master.emp.forecast.edr, aes(year, emp, color = emp.type, group = emp.type)) +
  facet_wrap(~EDR, ncol = 2, scales = "free_y") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = emp, tooltip = paste(EDR, "\nYear: ", year, "\nQuarter: ", quarter, "\nDate set: ", emp.type, "\nNumber of employees: ", comma(emp, accuracy = 1), sep = ""))) +
  geom_label_repel(data = filter(master.emp.forecast.edr, year == "2025-04-01"), aes(x = year, y = emp, label = comma(emp, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values = brewer.pal(n = 3, "PuBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18)) +
  labs(x="", y = "", color="", title = "Employment forecast before and after pandemic")

girafe(ggobj = emp.forecast.edr.plot, width_svg = 10, height_svg = 15) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

## Table

<br>

```{r table emp forecast}
emp.forecast.edr.table <- master.emp.forecast.edr %>%
  select(1,2,4,5,3) %>%
  arrange(EDR, year, quarter, emp.type) %>%
  rename("Year" = 2,
         "Quarter" = 3,
         "Model type" = 4,
         "Number of jobs" = 5) 

datatable(emp.forecast.edr.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) %>%
  formatCurrency(5, "")

```

<br>

# What occupations are projected to face workforce shortages and surpluses over the net 5-years?

Although this doesn't provide the severity of the surpluses or shortages in the workforce, it does provide us an idea about which occupations are needed across the entire state and which occupation groups might be needed in some regions and not others.

A review of the date shows that most occupation groups are projected to be either having a widespread workforce shortage or a widespread workforce surplus. Essentially, most occupations are either facing a workforce shortage or surplus in all EDRs (or nearly all). 

These occupations are projected to face workforce shortages across all or nearly all of Minnesota.

* Healthcare practitioners and technical
* Community and social service
* Architecture and engineering
* Computer and mathematical
* Life, physical and social science
* Business and financial operations
* Management
* Legal
* Installation, maintenance and repair
* Healthcare support
* Construction and extraction

These occupations are projected to face workforce surpluses across all or nearly all of Minnesota.

* Building and grounds cleaning and maintenance
* Farming, fishing and forestry
* Food preparation and serving related
* Office and administrative support
* Personal care and service
* Production
* Sales and related
* Transportation and material moving
* Protective service

It's worth mentioning that there are a few occupation groups projected to have workforce surpluses that are likely to be proven incorrect. For example, previous projections have listed production as an occupation group that will likely have workforce surpluses over that last 110 to 20 years. However, that never really came to fruition, particularly since 2010. This occupation group has consistently seen some of the largest workforce shortages in rural Minnesota. 

The following list are some occupation groups that rural Minnesota should be aware that projections have not captured the reality very well.

* Production
* Transportation and material moving
* Farming, fishing and forestry

There is really only one occupation group expected to face shortages in some EDRs and surpluses in others.

* Education, training, and library


<br>

```{r prep occupation groups facing workforce shortages, include=FALSE, cache=TRUE}
current.occ.groups.shortage <- read_csv("Data/Forecasts/current-occ-group-shortage-num-edrs.csv")

current.occ.groups.surplus <- read_csv("Data/Forecasts/current-occ-group-surplus-num-edrs.csv")

occ.groups.annual.shortages.surpluses.edr <- master.emp.forecast.occ.edr %>%
  group_by(edr, soc.level) %>%
  summarise(annual.supply.gap = sum(`Annual Supply Gap`, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(soc.level = paste(soc.level, "0000", sep = "")) %>%
  left_join(soc.codes, by = c("soc.level" = "soc.code")) %>%
  mutate(title = as.factor(title)) %>%
  mutate(shortage.surplus = ifelse(annual.supply.gap > 0, "Surplus", "Shortage")) %>%
  filter(annual.supply.gap != 0)

occ.groups.shortage.surplus.num.edrs <- occ.groups.annual.shortages.surpluses.edr %>%
  group_by(title, shortage.surplus) %>%
  summarise(num.edrs = n()) %>%
  ungroup() %>%
  complete(title, shortage.surplus, fill = list(num.edrs = 0)) %>%
  spread(key = shortage.surplus, value = num.edrs) %>%
  arrange(desc(Shortage), Surplus) %>%
  mutate(title = str_replace(title, "Community and Social Service", "Community and Social Services"),
         title = str_replace(title, "Building and Grounds Cleaning and Maintenance", "Building & Grounds Cleaning & Maintenance"))

names(occ.groups.shortage.surplus.num.edrs)

current.projected.occ.group.shortage.surplus.num.edrs <- occ.groups.shortage.surplus.num.edrs %>%
  full_join(current.occ.groups.shortage, by = c("title" = "Occ Group")) %>%
  full_join(current.occ.groups.surplus, by = c("title" = "Occ Group")) %>%
  select(1,4,2,6,3) %>%
  rename("Occ group" = 1,
         "Number of EDRs currently with workforce shortages" = 2,
         "Number of EDRs with projected workforce shortages" = 3,
         "Number of EDRs currently with workforce surpluses" = 4,
         "Number of EDRs with projected workforce surpluses" = 5)
```

<br>

```{r table num of edrs occupation groups facing shortages or surpluses}
datatable(select(current.projected.occ.group.shortage.surplus.num.edrs, 1,3,5), class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE))
```
<br>

The next question is how the list above compared to the current situation on the ground. Are the occupation groups projected to have workforce surpluses currently experiencing surpluses or shortages? If they are currently facing surpluses, are they projected to recover?

The following table provides the number of EDRs that each occupation group is currently facing workforce shortages and surpluses along with the number of EDRs that each occupation group is projected to face shortages and surpluses.

A quick review of the table shows quite a bit of overlap.

Here are the occupation groups that are currently experiencing widespread shortages or surpluses and are projected to continue.

* Shortages
  + Healthcare practitioners and technical
  + Community and social services
  + Life, physical and social sciences
  + Architecture and engineering

* Surpluses
  + Food preparation and serving related
  + Production
  + Sales and related
  + Building and grounds cleaning and maintenance
  + Office and administrative support
  + Farming, fishing and forestry
  + Protective service
  + Personal care and service
  
Again, it's worth mentioning here but projections for occupation groups such as production and farming, fishing and forestry may be wrong. They have been in the past. So instead of facing surpluses they may be facing shortages in the future. And one of the big reasons they are *currently* facing surpluses is because of the season in which the current unemployment data was pulled.

Here are the occupation groups that are expected to "recover", meaning they currently have widespread workforce surpluses but are projected to have shortages again.

* Healthcare support
* Construction and extraction (likely high surplus due to seasonal nature of work)
* Education, training and library
* Business and financial operations
* Installation, maintenance and repair
* Computer and mathematical
* Legal

This confirms that the need to provide resources to our workforce development organizations is necessary. We are going to have a lot of people on unemployment from occupations that don't require a lot of skills that are necessary for jobs that will be available. 

This is going to be particularly true in rural areas that are more reliant on tourism, recreation and service industries.


<br>

```{r table comparing occ groups and number of EDRs projected vs. current}
datatable(current.projected.occ.group.shortage.surplus.num.edrs, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE))
```
<br>

# Which EDRs will see transition from workforce surpluses to shortages and vice-versa?{.tabset}

The maps and table below provides the number of occupation groups that will experience each type of transition category for each EDR.

The transition categories are defined as occupations that will experience either a shortage, a surplus, or stable (neither stable or a surplus) in October and in projections. The category before the "-" is the October situation of the occ groups while the category listed after the "-" are the projections.

Not surprisingly, comparing the situations show that EDRs have many occupation groups that had a workforce shortage in October and that will continue, or they have too many workers (surplus) and that will also continue. These two situations typically make up 5 to 12 occupation groups in each EDR.

However, a few transitions do show up across the EDRs among a higher number of occupation groups. A transition among occupation groups from having too many workers in October to having not enough workers in the future occurs among 4 to 8 occupation groups particularly on the east side of Minnesota. In north central and north eastern Minnesota, they are projected to have 4 occupation groups transition from having too many workers in October to being stable in the future. Lastly, in southwest Minnesota, they are projected to have 4 occupation groups transition from having a stable number of workers to having a workforce shortage in the future for 4 occupation groups.

One other transition category worth mentioning are the occupation groups that had a workforce shortage in October but are projected to experience a surplus. There were about 1 to 3 occupation groups in this category and were mainly on the western side of Minnesota.
<br>

```{r prep comparison of occ group shortages surpluses by edr, include=FALSE, cache=TRUE}
ui.weekly.occ.edr <- ui.occ.edr %>%
  gather(key = "ui.date", value = "ui.claims", 3:(max(ncol(ui.occ.edr))-1)) %>%
  mutate(`Dim Title` = str_replace(`Dim Title`, " Occupations", ""),
         `Dim Title` = str_replace(`Dim Title`, " Occup.", ""),
         `Dim Title` = str_replace(`Dim Title`, " Occ", ""),
         `Dim Title` = as.factor(`Dim Title`)) %>%
  mutate(ui.date = mdy(ui.date),
         ui.month = month(ui.date, label = TRUE)) %>%
  group_by(edr, planning.region, `Dim Title`, ui.month) %>%
  mutate(week = seq(n())) %>%
  ungroup() %>%
  drop_na(ui.claims)

job.postings.weekly.occ.edr <- master.job.postings.with.family %>%
  group_by(edr, planning.region, posting.date) %>%
  distinct(jvid, .keep_all = TRUE) %>%
  ungroup() %>%
  group_by(edr, planning.region, posting.date, Job_Family) %>%
  summarise(job.postings = n()) %>%
  ungroup() %>%
  mutate(posting.month = month(posting.date, label = TRUE)) %>%
  group_by(edr, planning.region, Job_Family, posting.month) %>%
  mutate(week = seq(n())) %>%
  ungroup() %>%
  mutate(Job_Family = str_replace(Job_Family, "Community and Social Service", "Community and Social Services"),
         Job_Family = str_replace(Job_Family, "Building and Grounds Cleaning and Maintenance", "Building & Grounds Cleaning & Maintenance"),
         Job_Family = as.factor(Job_Family))


ui.job.postings.weekly.occ.edr <- ui.weekly.occ.edr %>%
  full_join(job.postings.weekly.occ.edr[,c(1,2,3,4,5,6,7)], by = c("edr", "planning.region", "ui.month" = "posting.month", "week", `Dim Title` = "Job_Family")) %>%
  filter(ui.month %in% c("Sep", "Oct"),
         `Dim Title` != "Total Claims",
         edr != "Minnesota") %>%
  group_by(edr, planning.region, ui.month, week) %>%
  fill(ui.date, .direction = "downup") %>%
  ungroup() %>%
  mutate(ui.claims = ifelse(is.na(ui.claims), 0, ui.claims),
         job.postings = ifelse(is.na(job.postings), 0, job.postings),
         job.posting.ui.difference = job.postings - ui.claims)

ui.job.postings.octavg.edr <- ui.job.postings.weekly.occ.edr %>%
  filter(ui.month == "Oct",
         `Dim Title` != "unknown") %>%
  group_by(edr, `Dim Title`) %>%
  summarise(avg.job.posting.ui.difference = round(mean(job.posting.ui.difference))) %>%
  ungroup() %>%
  mutate(shortage.surplus = ifelse(avg.job.posting.ui.difference > 0, "Shortage", "Surplus"))

labor.surplus.octavg.edr <- ui.job.postings.octavg.edr %>%
  filter(shortage.surplus == "Surplus",
         avg.job.posting.ui.difference < 0) 

labor.surplus.table <- labor.surplus.octavg.edr %>%
  group_by(edr) %>%
  arrange(avg.job.posting.ui.difference) %>%
  mutate(rank = seq(n())) %>%
  ungroup() %>%
  mutate(avg.job.posting.ui.difference = avg.job.posting.ui.difference * -1,
         label = paste(`Dim Title`, sep = "")) %>%
  select(1,5,6)

labor.shortages.occ.octavg <- ui.job.postings.octavg.edr %>%
  filter(shortage.surplus == "Shortage") %>%
  mutate(worker.label = avg.job.posting.ui.difference * -1) %>%
  group_by(edr) %>%
  arrange(worker.label) %>%
  mutate(rank = seq(n())) %>%
  ungroup()

labor.shortage.table <- labor.shortages.occ.octavg %>%
  mutate(label = paste(`Dim Title`, sep = "")) %>%
  select(1,6,7)

labor.shortage.surplus.table <- labor.surplus.table %>%
  left_join(labor.shortage.table, by = c("edr", "rank")) %>%
  arrange(edr, rank) %>%
  rename(EDR = 1,
         "Rank by severity of shortage or surplus" = 2,
         "Occupation group - current surplus" = 3,
         "Occupation group - current shortage" = 4)

current.labor.shortage.surplus <- labor.shortage.surplus.table %>%
  gather(key = "shortage.surplus", value = "occ.group", 3,4) %>%
  mutate(shortage.surplus = str_sub(shortage.surplus, 20, -1)) %>%
  rename("current.shortage.surplus"= 3)

names(current.labor.shortage.surplus)
  
occ.groups.annual.shortages.surpluses.edr.table <- occ.groups.annual.shortages.surpluses.edr %>%
  mutate(rank.annual.supply.gap = ifelse(shortage.surplus == "Shortage", annual.supply.gap*-1, annual.supply.gap)) %>%
  group_by(edr, shortage.surplus) %>%
  arrange(desc(rank.annual.supply.gap)) %>%
  mutate(rank = seq(n())) %>%
  ungroup() %>%
  mutate(label = paste(title, sep = "")) %>%
  select(7,1,5,8) %>%
  spread(key = shortage.surplus, value = label) %>%
  select(2,1,4,3) %>%
  rename(`EDR` = 1,
         `Rank by severity of shortage or surplus` = 2,
         `Occupation group - projected surplus` = 3,
         `Occupation group - projected shortage` = 4) %>%
  arrange(EDR) %>%
  gather(key = "shortage.surplus", value = "occ.group", 3,4) %>%
  mutate(shortage.surplus = str_sub(shortage.surplus, 20, -1)) %>%
  rename("projected.shortage.surplus" = 3)

occ.group.shortage.surplus.comparison <- occ.groups.annual.shortages.surpluses.edr.table %>%
  select(1,3,4) %>%
  mutate(occ.group =str_replace(occ.group, "Building and Grounds Cleaning and Maintenance", "Building & Grounds Cleaning & Maintenance	"),
         occ.group = str_replace(occ.group, "Community and Social Service", "Community and Social Services")) %>%
  full_join(current.labor.shortage.surplus[,c(1,3,4)], by = c("EDR", "occ.group")) %>%
  filter(!is.na(occ.group)) %>%
  mutate(current.label = current.shortage.surplus,
         current.label = str_replace(current.label, "current ", ""),
         current.label = ifelse(is.na(current.label), "stable", current.label),
         projected.label = projected.shortage.surplus,
         projected.label = str_replace(projected.label, "projected ", ""),
         projected.label = ifelse(is.na(projected.label), "stable", projected.label),
         transition = ifelse(projected.label == current.label, "No transition", "Transition"),
         transition.type = ifelse(current.label == "surplus" & projected.label == "surplus", "Continued surplus",
                                  ifelse(current.label == "surplus" & projected.label == "shortage", "Surplus to shortage",
                                         ifelse(current.label == "shortage" & projected.label == "surplus", "Shortage to surplus",
                                                ifelse(current.label == "shortage" & projected.label == "shortage", "Continued shortage",
                                                       ifelse(current.label == "stable" & projected.label == "surplus", "Stable to surplus",
                                                              ifelse(current.label == "stable" & projected.label == "stable", "Continued stable",
                                                                     ifelse(current.label == "stable" & projected.label == "shortage", "Stable to shortage",
                                                                            ifelse(current.label == "surplus" & projected.label == "stable", "Surplus to stable", "Shortage to stable")))))))),
         transition.type = as.factor(transition.type),
         occ.group = as.factor(occ.group))

num.occ.group.transition.category <- occ.group.shortage.surplus.comparison %>%
  group_by(EDR, transition.type) %>%
  summarise(transition.count = n()) %>%
  ungroup() %>%
  mutate(pct.occ.groups = transition.count / 24,
         label = paste(transition.count, " occ groups: ", percent(pct.occ.groups, accuracy = 1), sep = ""))

levels(occ.group.shortage.surplus.comparison$occ.group)

names(num.occ.group.transition.category)
names(occ.group.shortage.surplus.comparison)

  
```

## EDR maps

<br>

```{r map num occ groups transition category}
num.occ.group.transition.category.map <- num.occ.group.transition.category %>%
  select(1,2,3,4) %>%
  complete(EDR, transition.type, fill = list(transition.count = 0, pct.occ.groups = 0)) %>%
  mutate(RDCNUM = str_sub(EDR, 5,6),
         RDCNUM = trimws(RDCNUM, which = "both"),
         transition.count.bins = cut(transition.count,
                                     breaks = c(-1, 0, 3, 6, 9, 20),
                                     labels = c("0 occ groups", "1-3 occ groups", "4-6 occ groups", "7-9 occ groups", "10-12 occ groups")),
         transition.type = ifelse(transition.type == "Continued shortage", "Not enough workers - continued",
                                  ifelse(transition.type == "Continued surplus", "Too many workers - continued",
                                         ifelse(transition.type == "Shortage to stable", "Not enough workers - stable",
                                                ifelse(transition.type == "Shortage to surplus", "Not enough workers - too many workers",
                                                       ifelse(transition.type == "Stable to shortage", "Stable - not enough workers",
                                                              ifelse(transition.type == "Stable to surplus", "Stable - too many wokers",
                                                                     ifelse(transition.type == "Surplus to shortage", "Too many workers - not enough workers", "Too many workers - stable"))))))),
         transition.type = as.factor(transition.type),
         transition.type = fct_relevel(transition.type, "Not enough workers - continued", "Not enough workers - too many workers", "Not enough workers - stable",  "Too many workers - continued", "Too many workers - not enough workers", "Too many workers - stable", "Stable - not enough workers", "Stable - too many workers")) %>%
  left_join(mn_edrs[,c(5,10)], by = "RDCNUM")

mycolors <- brewer.pal(n = 5, "PuBu")

names(mycolors) <- levels(num.occ.group.transition.category.map$transition.count.bins)

num.occ.group.transition.category.plot <- ggplot(num.occ.group.transition.category.map) +
  facet_wrap(~transition.type, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = transition.count.bins, data_id = EDR, tooltip = paste(EDR, "\nTransition type: ", transition.type, "\nNumber of occs with transition type: ", transition.count, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = mycolors) +
  labs(title = paste("Number of occupation groups transition type - ", "\n", num.occ.group.transition.category.map$transition.type, sep = "")) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = num.occ.group.transition.category.plot, height_svg = 20, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))


```

## Table

```{r table num occ groups transition category}
num.occ.group.transition.category.table <- num.occ.group.transition.category %>%
  select(1,2,3,4) %>%
  mutate(transition.type = ifelse(transition.type == "Continued shortage", "Not enough workers - continued",
                                  ifelse(transition.type == "Continued surplus", "Too many workers - continued",
                                         ifelse(transition.type == "Shortage to stable", "Not enough workers - stable",
                                                ifelse(transition.type == "Shortage to surplus", "Not enough workers - too many workers",
                                                       ifelse(transition.type == "Stable to shortage", "Stable - not enough workers",
                                                              ifelse(transition.type == "Stable to surplus", "Stable - too many wokers",
                                                                     ifelse(transition.type == "Surplus to shortage", "Too many workers - not enough workers", "Too many workers - stable"))))))),
         transition.type = as.factor(transition.type),
         transition.type = fct_relevel(transition.type, "Not enough workers - continued", "Not enough workers - too many workers", "Not enough workers - stable",  "Too many workers - continued", "Too many workers - not enough workers", "Too many workers - stable", "Stable - not enough workers", "Stable - too many workers")) %>%
  complete(EDR, transition.type, fill = list(transition.count = 0, pct.occ.groups = 0)) %>%
  mutate(label = paste(transition.count, " occ groups, ", percent(pct.occ.groups, accuracy = 1), sep = ""),
         label = ifelse(label == "0 occ groups, 0%", "None", label)) %>%
  select(1,2,5) %>%
  spread(key = transition.type, value = label)

datatable(num.occ.group.transition.category.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) 

```


# What occupation groups are driving the transitions?

The table below provides each EDR and each occupation group along with their transition category from October 2020 to projections. 

Overall, what this table tells us is that not only do the occupation groups that are experienced a workforce shortage in October and are projected to continue this shortage require significant training or licensing, occupation groups that had too many workers in October or just enough workers but are projected to experience shortages also will require significant training and licensing. The occupation groups with too many workers all require less training and licensing on a whole.

From previous tables we already know which occupation groups are facing workforce shortages or surpluses across all of Minnesota and are projected to continue to be in these situations.

* Shortages
  + Healthcare practitioners and technical
  + Community and social services
  + Life, physical and social sciences
  + Architecture and engineering

* Surpluses
  + Food preparation and serving related
  + Production
  + Sales and related
  + Building and grounds cleaning and maintenance
  + Office and administrative support
  + Farming, fishing and forestry
  + Protective service
  + Personal care and service
  
As before, it's worth mentioning that some of the occupation groups that are currently experiencing workforce shortages are due to the seasonal nature of the industries within which those occupations occupy. And, that the projections for these occupation groups may be incorrect. This includes production, and farming, fishing and forestry.

In the previous section above, there were a few transition categories that are projected to occur in a number of occupation groups. Here's a breakdown of the occupations listed as having this particular transition and the number of EDRs in which they are projected to experience this situation.

* Management (12 EDRs)
* Business and financial operations (8 EDRs)
* Healthcare support (8 EDRs)
* Computer and mathematical (5 EDRs)
* Education, training and library (5 EDRs)
* Installation, maintenance and repair (4 EDRs)
* Legal (4 EDRs)
* Architecture and engineering (2 EDRs)

One occupation group expected to transition from surpluses to shortages as well, but is largely due to the seasonality of the work and experienced surpluses in October is construction and extraction (7 EDRs). This particular occupation group could really be listed as having a workforce shortage currently and is projected to as well. 

Another transition category that has a number of occupation groups projected to experience is from having too many workers to being stable. Here are the occupation groups that are projected to experience this transition along with the number of EDRs in which they are projected to experience this. All of these occupations require education, training and/or licensing. 

* Building and grounds cleaning and maintenance (12 EDRs)
* Arts, design, entertainment, sports and media (4 EDRs)
* Education, training and library (2 EDRs)
* Healthcare support (2 EDRs)
* Installation, maintenance and repair (2 EDRs)
* Legal (1 EDR)
* Business and financial operations (1 EDR)

Again, construction and extraction (5 EDRs) appear in this category and might as well be labeled as being stable entirely.

There were a few occupation groups projected to experience is going from having just enough workers to not enough. Here are those occupation groups. All of the occupation groups require training, education and/or licensing.

* Legal (3 EDRs)
* Installation maintenance and repair (2 EDRs)
* Computer and mathematical (1 EDR)
* Architecture and engineering (1 EDR)
* Life, physical, and social science (1 EDR)

Lastly, there was the transition from not having enough workers to having too many which was occuring a few occupation groups on the western side of Minnesota. Here are those occupation groups.

* Transportation and material moving (6 EDRs)
* Personal care and service (5 EDRs)
* Farming, fishing and forestry (2 EDRs)
* Protective service (1 EDR)
* Office and administrative support (1 EDR)

I'm a bit leary of the list above. Again, I think the projections have been underestimating the need for transportation and material moving for years, particularly in rural Minnesota.

<br>

```{r prep occupation groups and transition category}
occ.group.transition.category <- occ.group.shortage.surplus.comparison %>%
  mutate(transition.type = ifelse(transition.type == "Continued shortage", "Not enough workers - continued",
                                  ifelse(transition.type == "Continued surplus", "Too many workers - continued",
                                         ifelse(transition.type == "Shortage to stable", "Not enough workers - stable",
                                                ifelse(transition.type == "Shortage to surplus", "Not enough workers - too many workers",
                                                       ifelse(transition.type == "Stable to shortage", "Stable - not enough workers",
                                                              ifelse(transition.type == "Stable to surplus", "Stable - too many wokers",
                                                                     ifelse(transition.type == "Surplus to shortage", "Too many workers - not enough workers", "Too many workers - stable"))))))),
         transition.type = as.factor(transition.type),
         transition.type = fct_relevel(transition.type, "Not enough workers - continued", "Not enough workers - too many workers", "Not enough workers - stable",  "Too many workers - continued", "Too many workers - not enough workers", "Too many workers - stable", "Stable - not enough workers", "Stable - too many workers")) %>%
  select(1,3,8)
```

```{r table occ group transition category}
datatable(occ.group.transition.category[order(occ.group.transition.category$EDR, occ.group.transition.category$transition.type), ],
          class = "cell-border stripe",
          filter = "top",
          rownames = FALSE,
          extensions = "RowGroup",
          options = list(scrollX = TRUE,
                         rowGroup = list(dataSrc = c(0,2))))

```

# What specific occupations are driving the projections?{.tabset}

And finally, the table below provides the specific occupations (6-digit SOC codes) that are driving the top-5 occupation groups expected to experience workforce shortages and workforce surpluses.

Here's a brief summary of the main specific occupations that are projected to have workforce shortages for any occupation group that's in an EDR's top-5 most severe shortage.

* Healthcare practitioners and technical (top-5 in 13 EDRs)
  + Registered nurses (by far the highest need)
  + Pretty much everything else under this occupation group
  
* Management (top-5 in 13 EDRs)
  + General and operations manager
  + Ag managers (especially on the western and southern parts of the state)
  + Personal service managers (entertainment etc) - particularly in north eastern part of the state
  + Financial managers
  + Construction managers

* Business and financial operations (top-5 in 12 EDRs)
  + Management analysts
  + Accountants and auditors
  + Market research analysts
  + Compliance officers
  + Pretty broad overall. Many specific occupations.

* Community and social services (top-5 in 10 EDRs)
  + Substance, abuse, behavioral disorder and mental health counselors
  + Marriage and family counselors
  + Social workers (in general)

* Computer and mathematical (top-5 in 7 EDRs)
  + Software developers
  + Analysts (in general)

* Construction and extraction (top-5 in 4 EDRs)
  + Carpenters
  + Plumbers, pipefitters and steamfitters
  + Trades (in general)
  
* Architecture and engineering (top-5 in 2 EDRs)
  + Mechanical engineers
  + Industrial engineers
  + Civil engineers

* Healthcare support (top-5 in 2 EDRs)
  + Medical assistants
  + Nursing assistants
  
Here's a brief summary of the main specific occupations that are projected to have workforce surpluses for any occupation group that's in an EDR's top-5 most severe surplus.

* Food preparation and serving related (top-5 in 13 EDRs)
  + Fast food and counter workers
  + Waiters and waitresses
  + Bartenders
  + Pretty much every specific occupation within this occupation group

* Office and administrative support (top-5 in 13 EDRs)
  + Pretty much every specific occupation
  
* Sales related (top-5 in 13 EDRs)
  + Cashiers
  + Retail salespersons

* Transportation and material moving (top-5 in 13 EDRs)
  + Laborers and freight, stock and material movers
  + Stockers and order tillers
  + Packers and packages
  
* Production (top-5 in 10 EDRs) 
  + Team assemblers (by far)
  + Pretty much all other specific occupations are listed. It's why I have a hard time believing these projections. I just don't see it.

* Personal care and service (top-5 in 3 EDRs)
  + Childcare workers (really?! I don't think so.)
  + Gambling services - particularly in EDR 2 - Headwaters and EDR 6W - Upper MN Valley
  + Amusement and recreation attendants - especially in north eastern Minnesota.

<br>

```{r prep specific occs driving projections, include=FALSE, cache=TRUE}
forecast.top5.shortage.surplus.list <- occ.groups.annual.shortages.surpluses.edr %>%
  mutate(label = ifelse(shortage.surplus == "Shortage", annual.supply.gap * -1, annual.supply.gap)) %>%
  group_by(edr, shortage.surplus) %>%
  arrange(desc(label)) %>%
  top_n(n = 5, wt = label) %>%
  mutate(rank = seq(n())) %>%
  ungroup() %>%
  filter(rank <= 5) %>%
  mutate(soc.level = str_sub(soc.level, 1, 2))

forecast.soc.top5.occ <- master.emp.forecast.occ.edr %>%
  mutate(soc.level = as.character(soc.level)) %>% 
  right_join(forecast.top5.shortage.surplus.list[,c(1,2,4,7,5)], by = c("edr", "soc.level")) %>%
  select(12,1,2,3,11,13,14,15,16) %>%
  filter(`Annual Supply Gap` != 0) %>%
  mutate(rank.annual.supply.gap = ifelse(`Annual Supply Gap` < 0, `Annual Supply Gap` * -1, `Annual Supply Gap`)) %>%
  group_by(edr, shortage.surplus, soc.level) %>%
  top_n(n = 5, wt = rank.annual.supply.gap) %>%
  arrange(desc(rank.annual.supply.gap)) %>%
  mutate(soc.rank = seq(n())) %>%
  ungroup() %>%
  arrange(edr, shortage.surplus, rank, soc.rank)

forecast.soc.top5.occ.shortage.table <- forecast.soc.top5.occ %>%
  filter(shortage.surplus == "Shortage") %>%
  select(1,8,7,3,4) %>%
  rename("EDR" = 1,
         "Rank by largest workforce shortage in occupation group" = 2,
         "Occupation group" = 3,
         "Occupation title" = 4,
         "Projected annual shortage" = 5)

forecast.soc.top5.occ.surplus.table <- forecast.soc.top5.occ %>%
  filter(shortage.surplus == "Surplus") %>%
  select(1,8,7,3,4) %>%
  rename("EDR" = 1,
         "Rank by largest workforce surplus in occupation group" = 2,
         "Occupation group" = 3,
         "Occupation title" = 4,
         "Projected annual surplus" = 5)

```

## Top-5 specific occupations driving projections in the top-5 occupation groups - workforce shortages

<br>

```{r table projected workforce shortage specific soc}
datatable(forecast.soc.top5.occ.shortage.table[order(forecast.soc.top5.occ.shortage.table$EDR, forecast.soc.top5.occ.shortage.table$`Rank by largest workforce shortage in occupation group`), ],
          class = "cell-border stripe",
          filter = "top",
          rownames = FALSE,
          extensions = "RowGroup",
          options = list(scrollX = TRUE,
                         rowGroup = list(dataSrc = c(0,2))))
```

## Top-5 specific occupations driving projections in the top-5 occupation groups - workforce surpluses

<br>

```{r table projected workforce surplus specific soc}
datatable(forecast.soc.top5.occ.surplus.table[order(forecast.soc.top5.occ.surplus.table$EDR, forecast.soc.top5.occ.surplus.table$`Rank by largest workforce surplus in occupation group`), ],
          class = "cell-border stripe",
          filter = "top",
          rownames = FALSE,
          extensions = "RowGroup",
          options = list(scrollX = TRUE,
                         rowGroup = list(dataSrc = c(0,2))))
```

<br>

# Overall, which regions are most at risk of continuing to have high unemployment?{.tabset}

After reviewing all of this data, the big question that needs to be answered is whether there are specific regions that are being impacted the most by the pandemic and what does that mean for the future? To answer this, we have to see which regions rely most on the employment of occupations that are seeing high unemployment and will continue to see high unemployment.

<br>

```{r prep pct of current employment within occ groups projected to experience surpluses and shortages, include=FALSE, cache=TRUE}
occ.group.projected.surplus.list <- occ.groups.annual.shortages.surpluses.edr %>%
  filter(shortage.surplus == "Surplus") %>%
  select(1,2,4)

total.emp.edr <- oes.edr %>%
  filter(OccCode == "000000") %>%
  select(1,7) %>%
  rename("total.emp" = 2) %>%
  mutate(edr = str_replace(edr, "  ", " "))

occ.group.projected.surplus.pct.emp <- oes.edr %>%
  select(1,4,7) %>%
  mutate(edr = str_replace(edr, "  ", " ")) %>%
  right_join(occ.group.projected.surplus.list, by = c("edr", "OccCode" = "soc.level")) %>%
  group_by(edr) %>%
  summarise(surplus.occ.group.emp = sum(EmpCount, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(total.emp.edr, by = "edr") %>%
  mutate(pct.emp = surplus.occ.group.emp / total.emp,
         with.without.production = "Including production")

occ.group.projected.surplus.wo.production.pct.emp <- oes.edr %>%
  select(1,4,7) %>%
  mutate(edr = str_replace(edr, "  ", " ")) %>%
  right_join(occ.group.projected.surplus.list, by = c("edr", "OccCode" = "soc.level")) %>%
  filter(title != "Production") %>%
  group_by(edr) %>%
  summarise(surplus.occ.group.emp = sum(EmpCount, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(total.emp.edr, by = "edr") %>%
  mutate(pct.emp = surplus.occ.group.emp / total.emp,
         with.without.production = "Not including production")

occ.group.projected.surplus.w.and.wo.production.pct.emp <- occ.group.projected.surplus.pct.emp %>%
  rbind(occ.group.projected.surplus.wo.production.pct.emp) %>%
  mutate(RDCNUM = str_sub(edr, 5,6),
         RDCNUM = trimws(RDCNUM, which = "both")) %>%
  left_join(mn_edrs[,c(5,10)], by = "RDCNUM")

```

```{r maps pct of current employment within occ groups projected to experience surpluses and shortages}
occ.group.projected.surplus.w.and.wo.production.pct.emp.map <- ggplot(occ.group.projected.surplus.w.and.wo.production.pct.emp) +
  facet_wrap(~with.without.production, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.emp, data_id = edr, tooltip = paste(edr, "\nEmployment in occupation groups projected to have workforce surpluses: ", comma(surplus.occ.group.emp, accuracy = 1), "\nTotal employment in region: ", comma(total.emp, accuracy = 1), "\nPercent of total employment: ", percent(pct.emp, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "PuBu", direction = 1, labels = scales::percent) +
  labs(title = "Percent of employment in occupation groups\nprojected to have workforce surpluses") +
  theme(text = element_text(size = 18),
        legend.position = "bottom",
        legend.text = element_text(angle = 65, hjust = .9))

girafe(ggobj = occ.group.projected.surplus.w.and.wo.production.pct.emp.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```
