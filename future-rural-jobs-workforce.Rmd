---
title: "Pandemic impacts to future projections"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

<link rel="stylesheet" href="styles.css" type="text/css">

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(extrafont)
library(readxl)
library(janitor)
library(lubridate)

loadfonts()
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")


```

```{r master job forecast, include=FALSE, cache=TRUE}
emp.forecast.edr <- read_xlsx("Data/Forecasts/employment-forecast-edr.xlsx") %>%
  gather(key = "year", value = "emp", 2:28) %>%
  mutate(quarter = str_sub(year, 5,6 ),
         emp.type = str_sub(year, -5, -1),
         emp.type = str_replace(emp.type, "imate", "base"),
         emp.type = ifelse(emp.type %in% c("base", "covid"), emp.type, "emp"),
         emp = round(emp),
         year = str_sub(year, 1,6),
         EDR = str_replace(EDR, "MN ", ""),
         EDR = str_replace(EDR, "  ", " "),
         EDR = str_replace(EDR, "EDR 1 - NW", "EDR 1 - Northwest"),
         EDR = str_replace(EDR, "EDR 6E - SW Central", "EDR 6E- Southwest Central"),
         EDR = str_replace(EDR, "EDR 6W - Upper MN Valley", "EDR 6W- Upper Minnesota Valley"),
         EDR = str_replace(EDR, "EDR 7E - East Central", "EDR 7E- East Central"),
         EDR = str_replace(EDR, "EDR 7W - Central", "EDR 7W- Central"),
         EDR = str_replace(EDR, "EDR 8 - SW", "EDR 8 - Southwest"),
         EDR = str_replace(EDR, "EDR 10 - SE", "EDR 10 - Southeast"),
         EDR = str_replace(EDR, "EDR 11 - Metro", "EDR 11 - 7 County Twin Cities"),
         EDR = fct_relevel(EDR, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>% 
  filter(EDR != "Minnesota")

emp.forecast.added.edr <- emp.forecast.edr %>%
  mutate(year = as.factor(year)) %>%
  filter(year %in% c("2020Q1", "2021Q2")) %>%
  droplevels() %>%
  group_by(EDR) %>%
  complete(year, emp.type, fill = list(emp = NA)) %>%
  ungroup() %>%
  filter(year != "2021Q2") %>%
  group_by(EDR) %>%
  mutate(emp = ifelse(is.na(emp), emp[emp.type == "emp"], emp)) %>%
  ungroup() %>%
  filter(emp.type != "emp")

master.emp.forecast.edr <- emp.forecast.edr %>%
  rbind(emp.forecast.added.edr) %>%
  mutate(year = lubridate::yq(year),
         emp.type = as.factor(emp.type),
         emp.type = ifelse(emp.type == "emp", "Historical",
                           ifelse(emp.type == "covid", "Event-based model", "Baseline model")),
         emp.type = as.factor(emp.type),
         emp.type = relevel(emp.type, "Historical", "Baseline model", "Event-based model"),
         quarter = ifelse(is.na(quarter), "Q1", quarter))

forecast.final.project <- master.emp.forecast.edr %>%
  filter(year == max(master.emp.forecast.edr$year),
         quarter == "Q2") %>%
  group_by(EDR) %>%
  mutate(baseline.event.diff = emp[emp.type == "Event-based model"] - emp[emp.type == "Baseline model"],
         baselind.event.diff.pct = baseline.event.diff / emp[emp.type == "Baseline model"]) %>%
  ungroup()
```

```{r master forecast occ gaps, include=FALSE, cache=TRUE}
master.emp.forecast.occ.edr <- read_csv("Data/Forecasts/Master-occ-gaps-5yr-edr.csv") %>%
  mutate(edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

```

```{r master occ list, include=FALSE, cache=TRUE}
soc.codes <- read_xlsx("Data/Job postings/soc-codes.xlsx") %>%
  mutate(major = ifelse(is.na(major), minor, major),
         major = ifelse(is.na(major), broad, major),
         major = ifelse(is.na(major), detailed, major),
         major = str_replace(major, "-", ""),
         major = as.factor(major)) %>%
  select(1,5) %>%
  rename(soc.code = 1) %>%
  mutate(title = str_replace(title, " Occupations", ""))

```

```{r master ui objects, include=FALSE, cache=TRUE}

ui.occ.edr <- read_csv("Data/UI/Master-ui-claims-occ-edr.csv") %>%
  mutate(edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast")) 

```

```{r master job postings objects, include=FALSE, cache=TRUE}
master.job.postings.with.family <- read_csv("Data/Job postings/master-job-postings-job-family.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         date = as_date(date),
         posting.date = as_date(posting.date))

master.job.postings.with.family.occ <- read_csv("Data/Job postings/master-job-postings-job-family-and-occ.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         date = as_date(date),
         posting.date = as_date(posting.date))

```

<br>

# How has the pandemic impacted employment forecasts?{.tabset}

Below are the number of jobs projected over the next 5 years in each EDR. There are three different datasets here, essentially. The first are the historical job numbers for each EDR before January 2020. After that, there are two projection models. The first model labeled "Baseline" were the job projections before the pandemic began. The second model labeled "Event-based" are the new projections since the pandemic has begun. This projection was modeled in quarter 3 of 2020. 

As the charts show, the pandemic caused a severe disruption in the number of jobs compared to what was projected for 2020. The event-based model currently projects a relatively quick recovery (v-shape) but a continued gap between what is projected now that the pandemic has occurred compared to the models before the pandemic began. This is due to the likely closure and slow recovery of the business directly impacted by the pandemic such as restaurants, bars, retail and other related industries.

<br>

## Trends

<br>

```{r chart emp forecast}
emp.forecast.edr.plot <- ggplot(master.emp.forecast.edr, aes(year, emp, color = emp.type, group = emp.type)) +
  facet_wrap(~EDR, ncol = 2, scales = "free_y") +
  geom_line(size = 3) +
  geom_point_interactive(size = 5, aes(data_id = emp, tooltip = paste(EDR, "\nYear: ", year, "\nQuarter: ", quarter, "\nDate set: ", emp.type, "\nNumber of employees: ", comma(emp, accuracy = 1), sep = ""))) +
  geom_label_repel(data = filter(master.emp.forecast.edr, year == "2025-04-01"), aes(x = year, y = emp, label = comma(emp, accuracy = 1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::comma)+
  theme_line+
  scale_color_manual(values = brewer.pal(n = 3, "PuBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18)) +
  labs(x="", y = "", color="", title = "Employment forecast before and after pandemic")

girafe(ggobj = emp.forecast.edr.plot, width_svg = 10, height_svg = 15) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

## Table

<br>

```{r table emp forecast}
emp.forecast.edr.table <- master.emp.forecast.edr %>%
  select(1,2,4,5,3) %>%
  arrange(EDR, year, quarter, emp.type) %>%
  rename("Year" = 2,
         "Quarter" = 3,
         "Model type" = 4,
         "Number of jobs" = 5) 

datatable(emp.forecast.edr.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) %>%
  formatCurrency(5, "")

```

<br>

# What occupations are projected to face workforce shortages and surpluses over the net 5-years?

Although this doesn't provide the severity of the surpluses or shortages in the workforce, it does provide us an idea about which occupations are needed across the entire state and which occupation groups might be needed in some regions and not others.

A review of the date shows that most occupation groups  are projected to be either having a widespread workforce shortage or a widespread workforce surplus. The only occupation groups that will have a workforce surplus in some regions while have a shortage in others are healthcare support, as well as education, training and library. The other occupations are projected to be pretty consistently having a shortage or a surplus in all regions of the state. 

When reviewing the table below, one theme that becomes noticeable is how well the most widespread occupation groups facing projected shortages match the current situation.

These occupations are projected to face workforce shortages across all of Minnesota and is also currently the situation according to the data from previous sections of this outline.

* Healthcare practitioners and technical
* Community and social service
* Architecture and engineering
* Computer and mathematical
* Life, physical and social science

There are a few occupations that are projected to be facing widespread workforce shortages across Minnesota but are currently facing surpluses in some of our EDRs. This means that these occupations are expected to recover soon from any pandemic impacts.

* Management
* Business and financial operations
* Installation, maintenance and repair
* Healthcare support

And then there are occupations that are projected to have workforce surpluses. What's interesting is that most of these are currently facing surpluses. This indicates that this isn't going to change anytime soon.

* Food preparation and serving related
* Sales related
* Office and administrative support

Lastly, there are occupations projected to have widespread workforce surpluses but don't really fit the current situation. Although it's challenging to determine why there are differences here, it's likely due to the way the projections are calculated. For example, these models have indicated a decline in manufacturing for many years but have consistently under-estimated how well manufacturing does from year-to-year. Thus, jobs in production occupations consistently outperform the models. This might be the case with some of these projections as well. IF I were to guess, this is likely the case for transportation and material moving.

* Transportation and material moving
* Production
* Personal care and service
* Farming, fishing and forestry
* Protective service.

<br>

```{r prep occupation groups facing workforce shortages, include=FALSE, cache=TRUE}
occ.groups.annual.shortages.surpluses.edr <- master.emp.forecast.occ.edr %>%
  group_by(edr, soc.level) %>%
  summarise(annual.supply.gap = sum(`Annual Supply Gap`, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(soc.level = paste(soc.level, "0000", sep = "")) %>%
  left_join(soc.codes, by = c("soc.level" = "soc.code")) %>%
  mutate(title = as.factor(title)) %>%
  mutate(shortage.surplus = ifelse(annual.supply.gap > 0, "Surplus", "Shortage")) %>%
  filter(annual.supply.gap != 0)

occ.groups.shortage.surplus.num.edrs <- occ.groups.annual.shortages.surpluses.edr %>%
  group_by(title, shortage.surplus) %>%
  summarise(num.edrs = n()) %>%
  ungroup() %>%
  complete(title, shortage.surplus, fill = list(num.edrs = 0)) %>%
  spread(key = shortage.surplus, value = num.edrs) %>%
  arrange(desc(Shortage), Surplus)
```

```{r table num of edrs occupation groups facing shortages or surpluses}
datatable(occ.groups.shortage.surplus.num.edrs, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE))
```
<br>

# How do current occupation groups facing workforce shortages or surpluses compare to projections?{.tabset}

The table above identified which occupations are either having widespread workforce shortages or surpluses. Any differences between regions in occupations will likely happen in 

[Need to summarise]

<br>

```{r prep comparison of occ group shortages surpluses by edr, include=FALSE, cache=TRUE}
ui.weekly.occ.edr <- ui.occ.edr %>%
  gather(key = "ui.date", value = "ui.claims", 3:(max(ncol(ui.occ.edr))-1)) %>%
  mutate(`Dim Title` = str_replace(`Dim Title`, " Occupations", ""),
         `Dim Title` = str_replace(`Dim Title`, " Occup.", ""),
         `Dim Title` = str_replace(`Dim Title`, " Occ", ""),
         `Dim Title` = as.factor(`Dim Title`)) %>%
  mutate(ui.date = mdy(ui.date),
         ui.month = month(ui.date, label = TRUE)) %>%
  group_by(edr, planning.region, `Dim Title`, ui.month) %>%
  mutate(week = seq(n())) %>%
  ungroup() %>%
  drop_na(ui.claims)

job.postings.weekly.occ.edr <- master.job.postings.with.family %>%
  group_by(edr, planning.region, posting.date) %>%
  distinct(jvid, .keep_all = TRUE) %>%
  ungroup() %>%
  group_by(edr, planning.region, posting.date, Job_Family) %>%
  summarise(job.postings = n()) %>%
  ungroup() %>%
  mutate(posting.month = month(posting.date, label = TRUE)) %>%
  group_by(edr, planning.region, Job_Family, posting.month) %>%
  mutate(week = seq(n())) %>%
  ungroup() %>%
  mutate(Job_Family = str_replace(Job_Family, "Community and Social Service", "Community and Social Services"),
         Job_Family = str_replace(Job_Family, "Building and Grounds Cleaning and Maintenance", "Building & Grounds Cleaning & Maintenance"),
         Job_Family = as.factor(Job_Family))


ui.job.postings.weekly.occ.edr <- ui.weekly.occ.edr %>%
  full_join(job.postings.weekly.occ.edr[,c(1,2,3,4,5,6,7)], by = c("edr", "planning.region", "ui.month" = "posting.month", "week", `Dim Title` = "Job_Family")) %>%
  filter(ui.month %in% c("Sep", "Oct"),
         `Dim Title` != "Total Claims",
         edr != "Minnesota") %>%
  group_by(edr, planning.region, ui.month, week) %>%
  fill(ui.date, .direction = "downup") %>%
  ungroup() %>%
  mutate(ui.claims = ifelse(is.na(ui.claims), 0, ui.claims),
         job.postings = ifelse(is.na(job.postings), 0, job.postings),
         job.posting.ui.difference = job.postings - ui.claims)

ui.job.postings.octavg.edr <- ui.job.postings.weekly.occ.edr %>%
  filter(ui.month == "Oct",
         `Dim Title` != "unknown") %>%
  group_by(edr, `Dim Title`) %>%
  summarise(avg.job.posting.ui.difference = round(mean(job.posting.ui.difference))) %>%
  ungroup() %>%
  mutate(shortage.surplus = ifelse(avg.job.posting.ui.difference > 0, "Shortage", "Surplus"))

labor.surplus.octavg.edr <- ui.job.postings.octavg.edr %>%
  filter(shortage.surplus == "Surplus",
         avg.job.posting.ui.difference < 0) 

labor.surplus.table <- labor.surplus.octavg.edr %>%
  group_by(edr) %>%
  arrange(avg.job.posting.ui.difference) %>%
  mutate(rank = seq(n())) %>%
  ungroup() %>%
  mutate(avg.job.posting.ui.difference = avg.job.posting.ui.difference * -1,
         label = paste(`Dim Title`, sep = "")) %>%
  select(1,5,6)

labor.shortages.occ.octavg <- ui.job.postings.octavg.edr %>%
  filter(shortage.surplus == "Shortage") %>%
  mutate(worker.label = avg.job.posting.ui.difference * -1) %>%
  group_by(edr) %>%
  arrange(worker.label) %>%
  mutate(rank = seq(n())) %>%
  ungroup()

labor.shortage.table <- labor.shortages.occ.octavg %>%
  mutate(label = paste(`Dim Title`, sep = "")) %>%
  select(1,6,7)

labor.shortage.surplus.table <- labor.surplus.table %>%
  left_join(labor.shortage.table, by = c("edr", "rank")) %>%
  arrange(edr, rank) %>%
  rename(EDR = 1,
         "Rank by severity of shortage or surplus" = 2,
         "Occupation group - current surplus" = 3,
         "Occupation group - current shortage" = 4)
  
occ.groups.annual.shortages.surpluses.edr.table <- occ.groups.annual.shortages.surpluses.edr %>%
  mutate(rank.annual.supply.gap = ifelse(shortage.surplus == "Shortage", annual.supply.gap*-1, annual.supply.gap)) %>%
  group_by(edr, shortage.surplus) %>%
  arrange(desc(rank.annual.supply.gap)) %>%
  mutate(rank = seq(n())) %>%
  ungroup() %>%
  mutate(label = paste(title, sep = "")) %>%
  select(7,1,5,8) %>%
  spread(key = shortage.surplus, value = label) %>%
  select(2,1,4,3) %>%
  rename(`EDR` = 1,
         `Rank by severity of shortage or surplus` = 2,
         `Occupation group - projected surplus` = 3,
         `Occupation group - projected shortage` = 4) %>%
  arrange(EDR)

occ.group.shortage.surplus.comparison <- occ.groups.annual.shortages.surpluses.edr.table %>%
  full_join(labor.shortage.surplus.table, by = c("EDR", "Rank by severity of shortage or surplus"))


names(labor.shortage.surplus.table)
names(occ.groups.annual.shortages.surpluses.edr.table)

  
```

## Occupation groups with workforce shortages comparison - current vs. projections

<br>

```{r table occupation group with workforce shortages comparison}
occ.group.shortage.comparison.table <- occ.group.shortage.surplus.comparison %>%
  select(1,2,4,6) %>%
  rename(`Rank by severity of shortage` = 2)

datatable(occ.group.shortage.comparison.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) 
```

## Occupation groups with workforce surpluses comparison - current vs. projections

<br>

```{r table occupation group with workforce surplus comparison}
occ.group.surplus.comparison.table <- occ.group.shortage.surplus.comparison %>%
  select(1,2,3,5) %>%
  rename(`Rank by severity of surplus` = 2)

datatable(occ.group.surplus.comparison.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) 
```

<br>

# What specific occupations are driving the projections?{.tabset}

Summary here

```{r prep specific occs driving projections, include=FALSE, cache=TRUE}


```

## Top-5 specific occupations driving projections in the top-5 occupation groups - workforce shortages

<br>

## Top-5 specific occupations driving projections in the top-5 occupation groups - workforce surpluses




